<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>AR Test</title>
    <style>
        /*@import url(Widgets/widgets.css);*/
        html, body, #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
    </style>
</head>
<body>
    
<div id="cesiumContainer"></div>
<script type="text/javascript" src="ThirdParty/webxr-polyfill.js"></script>
<script type="text/javascript" src="BOSGeo/BOSGeo.js"></script>
<script>
   window.CESIUM_BASE_URL = './';
    navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
    if (supported) {
        navigator.xr.requestSession('immersive-ar')
        .then((session) => {
            session.isImmersive = true;

            let xrRefSpace = null;
            var container = document.getElementById('cesiumContainer');
            let canvas = document.createElement('canvas');
            let gl = canvas.getContext('webgl', {
              xrCompatible: true
            });

            var element = document.createElement("div");
            element.className = "cesium-widget";
            container.appendChild(element);
            element.appendChild(canvas);

            session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });
            session.requestReferenceSpace('local').then((refSpace) => {
                xrRefSpace = refSpace;
                session.requestAnimationFrame(onXRFrame);
                // let bos = new BOSGeo.GeoMap(container,canvas, gl, element,{
                    // session : session
                // });
                // bos.viewer.scene.globe.show = false;
                function onXRFrame(frameTime, frame){
                    // console.log(canvas.clientWidth)
                    let session = frame.session;
                    let pose = frame.getViewerPose(xrRefSpace);
                    if(pose){
                        gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);

                        // Update the clear color so that we can observe the color in the
                        // headset changing over time. Use a scissor rectangle to keep the AR
                        // scene visible.
                        const width = session.renderState.baseLayer.framebufferWidth;
                        const height = session.renderState.baseLayer.framebufferHeight;
                        // console.log(canvas.width)
                        gl.enable(gl.SCISSOR_TEST);
                        gl.scissor(width / 4, height / 4, width / 2, height / 2);
                        let time = Date.now();
                        gl.clearColor(Math.cos(time / 2000), Math.cos(time / 4000), Math.cos(time / 6000), 0.5);
                        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                    }
                    session.requestAnimationFrame(onXRFrame);
                }
            });

       
            // let bos = new BOSGeo.GeoMap('cesiumContainer',{
            //     session : session
            // });
            // bos.viewer.scene.globe.show = false;
        });
    }
});
</script>
</body>
</html>
